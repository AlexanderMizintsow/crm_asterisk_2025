<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }
      .log {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .test-btn {
        background-color: #007bff;
        color: white;
      }
      .auth-btn {
        background-color: #28a745;
        color: white;
      }
    </style>
  </head>
  <body>
    <h1>üîå WebSocket Test Client</h1>

    <div id="status" class="status disconnected">‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>

    <div>
      <button class="auth-btn" onclick="authenticate()">
        üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (ID: 1)
      </button>
      <button class="test-btn" onclick="testIncomingCall()">
        üìû –¢–µ—Å—Ç –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
      </button>
    </div>

    <h3>üìã –õ–æ–≥–∏:</h3>
    <div id="log" class="log"></div>

    <script>
      const socket = io("http://localhost:3771");
      const statusDiv = document.getElementById("status");
      const logDiv = document.getElementById("log");

      function log(message) {
        const time = new Date().toLocaleTimeString();
        logDiv.innerHTML += `[${time}] ${message}\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      function updateStatus(connected) {
        if (connected) {
          statusDiv.className = "status connected";
          statusDiv.innerHTML = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É";
        } else {
          statusDiv.className = "status disconnected";
          statusDiv.innerHTML = "‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω";
        }
      }

      // WebSocket —Å–æ–±—ã—Ç–∏—è
      socket.on("connect", () => {
        log("‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω");
        updateStatus(true);
      });

      socket.on("disconnect", () => {
        log("‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω");
        updateStatus(false);
      });

      socket.on("connect_error", (error) => {
        log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
        updateStatus(false);
      });

      socket.on("authenticated", (data) => {
        log(`‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞: ${JSON.stringify(data)}`);
      });

      socket.on("incoming-call", (call) => {
        log(`üéâ –ü–û–õ–£–ß–ï–ù–û –°–û–ë–´–¢–ò–ï incoming-call!`);
        log(`üìû –î–∞–Ω–Ω—ã–µ –∑–≤–æ–Ω–∫–∞: ${JSON.stringify(call, null, 2)}`);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        if (Notification.permission === "granted") {
          new Notification("–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫", {
            body: `–û—Ç: ${call.caller_number}\n–ù–∞: ${call.receiver_number}`,
            icon: "üìû",
          });
        }
      });

      function authenticate() {
        log("üîê –û—Ç–ø—Ä–∞–≤–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...");
        socket.emit("authenticate", { userId: 1 });
      }

      function testIncomingCall() {
        log("üìû –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–≤–æ–Ω–∫–∞...");
        const testCall = {
          id: Date.now(),
          caller_number: "+7 (495) 123-45-67",
          receiver_number: "777",
          timestamp: new Date().toISOString(),
          status: "incoming",
          assigned_user_id: 1,
          caller_company_name: "–û–û–û –¢–µ—Å—Ç–æ–≤–∞—è –ö–æ–º–ø–∞–Ω–∏—è",
        };
        socket.emit("incoming-call", testCall);
      }

      // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      if (Notification.permission === "default") {
        Notification.requestPermission();
      }

      log("üöÄ WebSocket —Ç–µ—Å—Ç –∫–ª–∏–µ–Ω—Ç –∑–∞–ø—É—â–µ–Ω");
      log('üí° –ù–∞–∂–º–∏—Ç–µ "–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è" –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
    </script>
  </body>
</html>
