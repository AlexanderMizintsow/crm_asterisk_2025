# üìû –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –∑–≤–æ–Ω–∫–æ–≤

## üéØ –ì–ª–∞–≤–Ω–∞—è –∏–¥–µ—è

–°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∑–≤–æ–Ω–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —Ç–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º, –∫–æ—Ç–æ—Ä—ã–º –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤—Ö–æ–¥—è—â–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.

## üîÑ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∑–≤–æ–Ω–∫–∞

### 1. –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫

```
–ó–≤–æ–Ω–æ–∫ –Ω–∞ –Ω–æ–º–µ—Ä 777 ‚Üí –°–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ ‚Üí –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ò–≤–∞–Ω–æ–≤—É
```

**–°–æ–±—ã—Ç–∏—è Asterisk:**

- `Event: Newchannel` - —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
- `CallerIDNum:` - –Ω–æ–º–µ—Ä –∑–≤–æ–Ω—è—â–µ–≥–æ
- `Exten:` - –Ω–æ–º–µ—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª—è (777)

**–î–µ–π—Å—Ç–≤–∏—è —Å–∏—Å—Ç–µ–º—ã:**

1. –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ –ë–î —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `"incoming"`
2. –ò—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –Ω–æ–º–µ—Ä—É 777 –≤ —Ç–∞–±–ª–∏—Ü–µ `user_phones`
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ò–≤–∞–Ω–æ–≤—É
4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–≤–æ–Ω–∫–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

### 2. –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–≤–æ–Ω–∫–∞

```
–ò–≤–∞–Ω–æ–≤ –ø–æ–¥–Ω–∏–º–∞–µ—Ç —Ç—Ä—É–±–∫—É ‚Üí Asterisk –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Event: Answer ‚Üí –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å
```

**–°–æ–±—ã—Ç–∏—è Asterisk:**

- `Event: Answer` - –∑–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç

**–î–µ–π—Å—Ç–≤–∏—è —Å–∏—Å—Ç–µ–º—ã:**

1. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∑–≤–æ–Ω–∫–∞ –Ω–∞ `"answered"`
2. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è –ø—Ä–∏–Ω—è—Ç–∏—è `answered_at`

### 3. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞

```
–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω ‚Üí Asterisk –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Event: Hangup ‚Üí –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```

**–°–æ–±—ã—Ç–∏—è Asterisk:**

- `Event: Hangup` - –∑–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω

**–î–µ–π—Å—Ç–≤–∏—è —Å–∏—Å—Ç–µ–º—ã:**

1. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ `"completed"`
2. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è `ended_at`
3. –í—ã—á–∏—Å–ª—è–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–≤–æ–Ω–∫–∞

## üìä –°—Ç–∞—Ç—É—Å—ã –∑–≤–æ–Ω–∫–æ–≤

| –°—Ç–∞—Ç—É—Å      | –û–ø–∏—Å–∞–Ω–∏–µ           | –ö–æ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è                    |
| ----------- | ------------------ | ---------------------------------------- |
| `incoming`  | –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫    | –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–≤–æ–Ω–∫–µ |
| `answered`  | –ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç      | –ü—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ Event: Answer                |
| `completed` | –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω    | –ü—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ Event: Hangup                |
| `missed`    | –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫ | –ï—Å–ª–∏ –∑–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –±–µ–∑ –ø—Ä–∏–Ω—è—Ç–∏—è      |
| `rejected`  | –ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω    | –ü—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å           |

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### Asterisk —Å–µ—Ä–≤–µ—Ä (`asterisk-server.js`)

- –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Asterisk AMI
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –°–æ–∑–¥–∞–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ –ë–î
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket

### WebSocket —Å–µ—Ä–≤–µ—Ä (`websocket-server.js`)

- –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–≤–æ–Ω–∫–∞—Ö
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

### –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å

- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–∞—Ö
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å/–æ—Ç–∫–ª–æ–Ω—è—Ç—å –∑–≤–æ–Ω–∫–∏
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∑–≤–æ–Ω–∫–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è

```bash
cd server
node test-scenario.js
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä—ã: `npm run servers`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç: `node test-scenario.js`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `users`

```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  status VARCHAR(50)
);
```

### –¢–∞–±–ª–∏—Ü–∞ `user_phones`

```sql
CREATE TABLE user_phones (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  phone_number VARCHAR(20) UNIQUE
);
```

### –¢–∞–±–ª–∏—Ü–∞ `calls`

```sql
CREATE TABLE calls (
  id SERIAL PRIMARY KEY,
  caller_number VARCHAR(20),
  receiver_number VARCHAR(20),
  accepted_at TIMESTAMP,
  answered_at TIMESTAMP,
  ended_at TIMESTAMP,
  status VARCHAR(20),
  assigned_user_id INTEGER REFERENCES users(id),
  answered_by_user_id INTEGER REFERENCES users(id),
  caller_company_id INTEGER,
  channel_id VARCHAR(100),
  duration INTEGER,
  notes TEXT
);
```

## üéØ –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã

1. **–ó–≤–æ–Ω–æ–∫ –Ω–∞ 777** ‚Üí –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç –ò–≤–∞–Ω–æ–≤–∞ ‚Üí –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
2. **–ò–≤–∞–Ω–æ–≤ –ø–æ–¥–Ω–∏–º–∞–µ—Ç —Ç—Ä—É–±–∫—É** ‚Üí –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "answered"
3. **–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è** ‚Üí –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
4. **–í –∏—Å—Ç–æ—Ä–∏–∏** ‚Üí –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–≤–æ–Ω–∫–µ

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

- –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å **–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏** (777, 888, etc.)
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ **–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º**
- –ó–≤–æ–Ω–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è **–≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏**
- –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è **–ª–æ–≥–∏—Ä—É—é—Ç—Å—è** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
